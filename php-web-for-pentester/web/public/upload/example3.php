<?php require_once("../header.php"); ?>

<?php

function isImage($filename){
    //需要开启php_exif模块
    $image_type = exif_imagetype($filename);
    switch ($image_type) {
        case IMAGETYPE_GIF:
            return "gif";
            break;
        case IMAGETYPE_JPEG:
            return "jpg";
            break;
        case IMAGETYPE_PNG:
            return "png";
            break;    
        default:
            return false;
            break;
    }
}

if(isset($_FILES['image']))
{ 
  $dir = '/var/www/upload/images/';
  $stream = $_FILES['image']['tmp_name'];
  $fileTypeName = isImage($stream);
  if (!($fileTypeName == "gif" || $fileTypeName == "png" || $fileTypeName == "jpg" || $fileTypeName == "jpeg")) {
    echo "no suite for type";
    die("file no suite for type");
  }

  $file = basename($_FILES['image']['name']);
	if (preg_match('/\.php$/',$file)) {
		DIE("NO PHP");
	}


  echo "bypassed<br>";

  if(move_uploaded_file($_FILES['image']['tmp_name'], $dir . $file))
  {
  echo 'Upload done !';
  echo 'Your file can be found <a href="/upload/images/'.htmlentities($file).'">here</a>';
  }
  else 
  { 
  	echo 'Upload failed';
  }
}
?>


<form method="POST" action="example3.php" enctype="multipart/form-data">	
Image: <input type="file" name="image"><br/>
<input type="submit" name="send" value="Send file">

</form> 

<?php require_once("../footer.php"); ?>